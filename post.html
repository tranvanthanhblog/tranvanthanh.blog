<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bài viết</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="dark">

<div class="post-wrap">

  <button onclick="history.back()" class="btn">← Quay lại</button>

  <h1 id="title"></h1>

  <div id="media" class="post-media"></div>

  <div id="content" class="post-content"></div>


  <!-- COMMENT -->
  <h2>Bình luận</h2>

  <div class="comment-input-box">
    <input id="cmtInput" placeholder="Viết bình luận..." />
    <button id="btnSend">Gửi</button>
  </div>

  <div id="commentList"></div>

</div>


<script src="db.js"></script>

<script>
const id = localStorage.getItem("viewPost");

const titleEl = document.getElementById("title");
const mediaBox = document.getElementById("media");
const contentEl = document.getElementById("content");
const commentList = document.getElementById("commentList");
const btnSend = document.getElementById("btnSend");
const cmtInput = document.getElementById("cmtInput");

let currentUser=null;

DB.auth.onAuthStateChanged(u=> currentUser=u);

function renderVideo(url){
  return `<video src="${url}" controls></video>`;
}

DB.getPost(id).then(post=>{
  titleEl.innerText = post.title;
  mediaBox.innerHTML = renderVideo(post.media);
  contentEl.innerHTML = post.content.replace(/\n/g,"<br>");
});

btnSend.onclick=()=>{
  if(!currentUser) return alert("Đăng nhập đi");

  DB.addComment(id,cmtInput.value,currentUser);
  cmtInput.value="";
};

DB.getComments(id,(comments)=>{

  commentList.innerHTML="";

  comments.forEach(c=>{

    const item=document.createElement("div");
    item.className="comment-item";

    item.innerHTML=`
      <img src="avatar.jpg" class="avatar">
      <span>${c.email}: ${c.text}</span>
    `;

    if(currentUser &&
      (currentUser.uid===c.uid || DB.isAdminEmail(currentUser.email))){
        const del=document.createElement("button");
        del.innerText="❌";
        del.className="btn-del";
        del.onclick=()=>DB.deleteComment(c.id);
        item.appendChild(del);
    }

    commentList.appendChild(item);
  });
});
</script>

</body>
</html>

