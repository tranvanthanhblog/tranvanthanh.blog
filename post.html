<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bài viết</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="dark">

<div class="post-wrap">

  <button onclick="history.back()" class="btn">← Quay lại</button>

  <h1 id="title"></h1>

  <div id="media" class="post-media"></div>

  <div id="content" class="post-content"></div>


  <!-- COMMENT -->
  <h2>Bình luận</h2>

  <div class="comment-input-box">
    <input id="cmtInput" placeholder="Viết bình luận..." />
    <button id="btnSend">Gửi</button>
  </div>

  <div id="commentList"></div>

</div>


<script src="db.js"></script>

<script>
const id = localStorage.getItem("viewPost");

const titleEl = document.getElementById("title");
const mediaBox = document.getElementById("media");
const contentEl = document.getElementById("content");
const commentList = document.getElementById("commentList");
const btnSend = document.getElementById("btnSend");
const cmtInput = document.getElementById("cmtInput");

let currentUser = null;


/* ===== auth ===== */
DB.auth.onAuthStateChanged(u => currentUser = u);


/* ===== video ===== */
function renderVideo(url){
  if(!url) return "";
  return `<video src="${url}" controls></video>`;
}


/* ===== load post ===== */
DB.getPost(id).then(post=>{
  titleEl.innerText = post.title;
  mediaBox.innerHTML = renderVideo(post.media);
  contentEl.innerHTML = post.content.replace(/\n/g,"<br>");
});


/* ===== add comment ===== */
btnSend.onclick = ()=>{
  if(!currentUser){
    alert("Đăng nhập để comment");
    return;
  }

  if(!cmtInput.value.trim()) return;

  DB.addComment(id, cmtInput.value, currentUser);

  cmtInput.value="";
};


/* ===== render comment ===== */
DB.getComments(id, (comments)=>{

  commentList.innerHTML="";

  comments.forEach(c=>{

    const div = document.createElement("div");
    div.className="comment-item";

    // avatar
    const avatar = document.createElement("img");
    avatar.src="avatar.jpg";
    avatar.className="avatar";

    // text
    const text = document.createElement("span");
    text.innerText = c.email + ": " + c.text;

    div.appendChild(avatar);
    div.appendChild(text);

    // ⭐ chỉ admin hoặc chủ comment mới xoá
    if(currentUser &&
      (currentUser.uid === c.uid || DB.isAdminEmail(currentUser.email))
    ){
      const del = document.createElement("button");
      del.innerText="❌";
      del.className="btn-del";
      del.onclick = ()=> DB.deleteComment(c.id);

      div.appendChild(del);
    }

    commentList.appendChild(div);

  });

});
</script>

</body>
</html>
