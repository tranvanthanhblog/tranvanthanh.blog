<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Tr·∫ßn VƒÉn Th√†nh Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  </head>

  <body>
    <div class="feed">
      <button onclick="history.back()" class="btn ghost">‚Üê Quay l·∫°i</button>

      <h2 id="title"></h2>

      <!-- MEDIA -->
      <div id="media" class="post-media"></div>

      <!-- CONTENT -->
      <div id="content" class="post-content"></div>

      <!-- COMMENTS -->
      <div class="comment-box">
        <h3>B√¨nh lu·∫≠n</h3>

        <div id="commentList"></div>

        <div class="comment-input">
          <input id="cmtInput" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." />
          <button id="btnSend">G·ª≠i</button>
        </div>
      </div>
    </div>

    <script src="db.js"></script>

    <script>
      const id = localStorage.getItem("viewPost");
      let currentUser = null;

      function renderMedia(url) {
        if (!url) return "";

        if (url.endsWith(".mp4")) {
          return `<video src="${url}" controls></video>`;
        }

        return `<img src="${url}" />`;
      }

      DB.auth.onAuthStateChanged((u) => {
        currentUser = u;
      });

      // ===== LOAD POST =====
      DB.onPosts((posts) => {
        const post = posts.find((p) => p.id === id);
        if (!post) return;

        title.textContent = post.title;

        mediaBox.innerHTML = renderMedia(post.media);


        content.innerHTML = post.content.replace(/\n/g, "<br>");

        renderComments(post);
      });

      // ===== COMMENTS =====
      function renderComments(post) {
        commentList.innerHTML = "";

        const comments = post.comments || {};

        Object.entries(comments).forEach(([cid, c]) => {
          const div = document.createElement("div");
          div.className = "comment";

          div.innerHTML = `
            <img src="${c.photo}" />
            <b>${c.name}</b>
            <span>${c.text}</span>
            ${
              currentUser && DB.isAdmin(currentUser)
                ? `<span class="del-cmt">üóë</span>`
                : ""
            }
          `;

          const del = div.querySelector(".del-cmt");
          if (del) {
            del.onclick = () => DB.deleteComment(id, cid);
          }

          commentList.appendChild(div);
        });
      }

      // ===== SEND COMMENT =====
      btnSend.onclick = () => {
        if (!currentUser) {
          alert("ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n");
          return;
        }

        if (!cmtInput.value.trim()) return;

        const cid = Date.now();

        firebase
          .database()
          .ref(`posts/${id}/comments/${cid}`)
          .set({
            text: cmtInput.value,
            name: currentUser.displayName,
            photo: currentUser.photoURL,
          });

        cmtInput.value = "";
      };
    </script>
  </body>
</html>



